function _asyncToGenerator(a){return function(){var b=a.apply(this,arguments);return new Promise(function(a,c){function d(e,f){try{var g=b[e](f),h=g.value}catch(a){return void c(a)}return g.done?void a(h):Promise.resolve(h).then(function(a){d('next',a)},function(a){d('throw',a)})}return d('next')})}}const qs=require('querystring'),Url=require('url'),{getBaseUrl,sleep,get,post,parseString}=require('./helpers');class Jenkins{constructor(a,b,c,d={}){this.token=b,this.baseUrl=getBaseUrl(a,b,c),this.urlParams={token:b},this.headers=Object.assign({},{Authorization:this.urlParams.token},d),this.crumb=null}info(a=null){var b=this;return _asyncToGenerator(function*(){return a?get(...(yield b._getRequest(`${a}/api/json`))):get(...(yield b._getRequest('/api/json')))})()}getJobInfo(a){var b=this;return _asyncToGenerator(function*(){return get(...(yield b._getRequest(a)))})()}getBuildInfo(a,b){var c=this;return _asyncToGenerator(function*(){return get(...(yield c._getRequest(a,b)))})()}getJobConfig(a){var b=this;return _asyncToGenerator(function*(){const c=yield get(...(yield b._getRequest(`${a}/config.xml`)));return parseString(c)})()}build(a){var b=this;return _asyncToGenerator(function*(){const[c,d]=yield b._getRequest(a,'/build');return post(c,null,d)})()}buildWithParams(a,b={}){var c=this;return _asyncToGenerator(function*(){const[d,e]=yield c._getRequest(a,'/buildWithParameters',b);return post(d,b,e)})()}progressiveText(a,b,c=100){var d=this;return _asyncToGenerator(function*(){for(let e=!0,f=0;e;){const[g]=yield d._getRequest(a,`/${b}/logText/progressiveText`),h=yield get(`${g}&start=${f}`,d.headers,!0),i=h.data;e=h.headers['x-more-data'],f=h.headers['x-text-size'],i&&console.log(i),yield sleep(c)}})()}_getCrumb(){var a=this;return _asyncToGenerator(function*(){const b=`${a.baseUrl}/crumbIssuer/api/json`,c=yield get(b);return a.crumb=c,c})()}_getRequest(a,b='',c=null){var d=this;return _asyncToGenerator(function*(){const e=Url.parse(a);a=e.pathname,a.startsWith('/')||(a=`/${a}`),a.endsWith('/')&&(a=a.slice(0,-1)),b.length&&!b.startsWith('/')&&(b=`/${b}`);const f=`${d.baseUrl}${a}${b}`,g=d.crumb||(yield d._getCrumb()),h=Object.assign({},d.headers,{[g.crumbRequestField]:g.crumb});return[`${f}?${qs.stringify(d.urlParams)}${c?`&${qs.stringify(c)}`:''}`,{headers:h}]})()}toString(){return`<Jenkins ${this.token}>`}}module.exports=Jenkins;
